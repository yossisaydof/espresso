# Database Design (Espresso – Issues Management System)

This folder describes the database schema used by the Espresso Issues Management System.

## Overview

The system currently uses a single main table:

- `issues` – stores all issues created, imported from CSV, and managed through the UI.

PostgreSQL is used as the relational database.

---

## `issues` Table

```sql
CREATE TABLE issues (
    id UUID PRIMARY KEY,
    title TEXT NOT NULL,
    description TEXT,
    status VARCHAR(20) NOT NULL,
    severity VARCHAR(10) NOT NULL,
    site TEXT NOT NULL,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ,
    resolved_at TIMESTAMPTZ
);
```

### Columns

- **id** – Unique identifier for the issue (UUID).  
  Generated by the application layer when creating a new issue.

- **title** – Short human-readable title of the issue.  
  Required.

- **description** – Optional free-text description with more details.

- **status** – Current state of the issue.  
  Allowed values (enforced via `CHECK` constraint):
  - `open`
  - `in_progress`
  - `resolved`
  - `closed`

- **severity** – How critical the issue is.  
  Allowed values:
  - `low`
  - `medium`
  - `high`
  - `critical`

- **site** – Logical or physical site / environment where the issue occurs  
  (for example: a data center, customer site, or application environment).  
  Required.

- **created_at** – When the issue was created.  
  - If importing from CSV and a `created_at` value exists, the backend uses it.  
  - Otherwise, the backend falls back to `NOW()` (current timestamp).

- **updated_at** – Last time the issue was updated.  
  Managed by the backend when performing updates.

- **resolved_at** – Timestamp of when the issue was resolved (if applicable).

---

## Constraints

```sql
ALTER TABLE issues
    ADD CONSTRAINT issues_status_check
    CHECK (status IN ('open', 'in_progress', 'resolved', 'closed'));

ALTER TABLE issues
    ADD CONSTRAINT issues_severity_check
    CHECK (severity IN ('low', 'medium', 'high', 'critical'));
```

These constraints help enforce data consistency and catch invalid values early.

---

## Indexes

```sql
CREATE INDEX idx_issues_status
    ON issues (status);

CREATE INDEX idx_issues_severity
    ON issues (severity);

CREATE INDEX idx_issues_site
    ON issues (site);

CREATE INDEX idx_issues_created_at
    ON issues (created_at);
```

These indexes are optimized for the most common query patterns in the application:

- Filtering by `status` (e.g. open issues)
- Filtering by `severity`
- Filtering by `site`
- Sorting or filtering by `created_at` (e.g. latest issues)

---

## CSV Import Mapping

The CSV import flow maps CSV columns to the `issues` table.

A typical `issues.csv` header might look like:

```csv
id,title,description,status,severity,site,createdAt,updatedAt,resolvedAt
```

The backend converts and maps these columns as follows:

- `id` → `id`
- `title` → `title`
- `description` → `description`
- `status` → `status`
- `severity` → `severity`
- `site` → `site`
- `createdAt` → `created_at` (if present, otherwise default)
- `updatedAt` → `updated_at`
- `resolvedAt` → `resolved_at`

This keeps the CSV format aligned with the database schema and makes it easier to import/export data consistently.
